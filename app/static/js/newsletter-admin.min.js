function updateBlockFields(e){const t=e.querySelector(".block-type"),l=e.querySelector(".content-label"),n=e.querySelector(".block-content"),o=e.querySelector(".image-url-label"),c=e.querySelector(".block-image-url"),r=e.querySelector(".alt-text-label"),a=e.querySelector(".block-alt-text"),i=e.querySelector(".url-text-label"),u=e.querySelector(".block-url-text"),b=e.querySelector(".colour-label"),d=e.querySelector(".block-colour");if(!t)return;function s(e,t){e&&(t?(e.classList.remove("no-display"),e.removeAttribute("disabled")):(e.classList.add("no-display"),e.disabled=!0))}const m={image:{content:!1,contentLabel:!1,imageUrl:!0,imageUrlLabel:!0,altText:!0,altTextLabel:!0,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},thumbnail:{content:!1,contentLabel:!1,imageUrl:!0,imageUrlLabel:!0,altText:!0,altTextLabel:!0,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},subheading:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},paragraph:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},button:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!0,urlTextLabel:!0,colourInput:!0,colourLabel:!0,labelText:"Button Text",urlLabelText:"Button Link"},default:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!0,colourLabel:!0,labelText:"Content"}},L=m[t.value]||m.default;L.contentLabel&&"string"==typeof L.labelText&&(l.textContent=L.labelText),L.urlTextLabel&&"string"==typeof L.labelText&&(i.textContent=L.urlLabelText),s(l,L.contentLabel),s(n,L.content),s(o,L.imageUrlLabel),s(c,L.imageUrl),s(r,L.altTextLabel),s(a,L.altText),s(i,L.urlTextLabel),s(u,L.urlText),s(b,L.colourLabel),s(d,L.colourInput)}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("add-block-btn"),t=document.getElementById("blocks-container"),l=document.getElementById("block-template"),n=document.getElementById("article-post");let o=0;function c(e,t,l){e.addEventListener("click",(function(e){e.preventDefault();const l=document.getElementById(t);l&&(l.remove(),a(),o--)}))}n.addEventListener("click",(function(e){confirm("Are you sure you want to upload this newsletter?")||e.preventDefault()})),t.querySelectorAll(".article-block").forEach((e=>{const t=e.querySelector(".block-type");t&&(t.addEventListener("change",(()=>updateBlockFields(e))),updateBlockFields(e));const l=e.querySelector(`#up-block-btn-${idx}`);l&&i(l,idx);const n=e.querySelector(`#down-block-btn-${idx}`);n&&u(n,idx)}));const r=document.querySelectorAll(".article-block");function a(){t.querySelectorAll(".article-block").forEach(((e,t)=>{e.id=`block-${t}`,e.querySelectorAll("[name], [id], [for]").forEach((e=>{e.name&&(e.name=e.name.replace(/article-blocks-\d+-/,`article-blocks-${t}-`)),e.id&&(e.id=e.id.replace(/article-blocks-\d+-/,`article-blocks-${t}-`)),e.htmlFor&&(e.htmlFor=e.htmlFor.replace(/article-blocks-\d+-/,`article-blocks-${t}-`))}));const l=e.querySelector('[id^="rmv-block-btn-"]');if(l){l.id=`rmv-block-btn-${t}`,l.replaceWith(l.cloneNode(!0));c(e.querySelector(`#rmv-block-btn-${t}`),`block-${t}`)}const n=e.querySelector('[id^="up-block-btn-"]');if(n){n.id=`up-block-btn-${t}`,n.replaceWith(n.cloneNode(!0));i(e.querySelector(`#up-block-btn-${t}`),t)}const o=e.querySelector('[id^="down-block-btn-"]');if(o){o.id=`down-block-btn-${t}`,o.replaceWith(o.cloneNode(!0));u(e.querySelector(`#down-block-btn-${t}`),t)}}))}function i(e,t){e.addEventListener("click",(function(e){e.preventDefault(),function(e){const t=document.getElementById(`block-${e}`);if(!t)return;const l=t.previousElementSibling;l&&l.classList.contains("article-block")&&(t.parentNode.insertBefore(t,l),a())}(t)}))}function u(e,t){e.addEventListener("click",(function(e){e.preventDefault(),function(e){const t=document.getElementById(`block-${e}`);if(!t)return;const l=t.nextElementSibling;l&&l.classList.contains("article-block")&&(t.parentNode.insertBefore(t,l.nextSibling),a())}(t)}))}r.length&&r.length>0&&(o=r.length-1),e.addEventListener("click",(function(e){e.preventDefault();const n=l.cloneNode(!0);n.classList.remove("no-display"),n.removeAttribute("disabled");const r=n.innerHTML.replace(/__INDEX__/g,o);n.innerHTML=r,n.id=`block-${o}`;n.querySelector(".block-type").addEventListener("change",(function(){updateBlockFields(n)}));const a=n.querySelector(`#rmv-block-btn-${o}`);a&&c(a,`block-${o}`);const b=n.querySelector(`#up-block-btn-${o}`);b&&i(b,o);const d=n.querySelector(`#down-block-btn-${o}`);d&&u(d,o),t.appendChild(n),o++,updateBlockFields(n)})),document.getElementById("preview-button").addEventListener("click",(async function(){const e=document.getElementById("article-form"),t=new FormData(e),l=document.getElementById("preview-spinner"),n=document.getElementById("preview-error"),o=Date.now();l.style.display="flex",n.textContent="",await fetch(`/HDPSC-admin-panel/download-newsletter?ts=${o}`,{method:"POST",body:t}).then((async e=>{if(!e.ok){const t=await e.json();if(t.errors){let e="";for(const[l,n]of Object.entries(t.errors))e+=`${l}: ${n.join(", ")}\n`;throw new Error(e)}throw new Error(t.error||"Something went wrong")}return e.text()})).then((e=>{const t=new Blob([e],{type:"text/html"}),l=URL.createObjectURL(t),n=document.createElement("a");n.href=l,n.download=`newsletter-${o}.html`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(l)})).catch((e=>{n.textContent=e.message})).finally((()=>{l.style.display="none"}))}))}));