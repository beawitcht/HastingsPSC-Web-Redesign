function updateBlockFields(e){const t=e.querySelector(".block-type"),l=e.querySelector(".content-label"),o=e.querySelector(".block-content"),n=e.querySelector(".image-url-label"),r=e.querySelector(".block-image-url"),a=e.querySelector(".alt-text-label"),c=e.querySelector(".block-alt-text"),u=e.querySelector(".url-text-label"),i=e.querySelector(".block-url-text"),b=e.querySelector(".colour-label"),d=e.querySelector(".block-colour");if(!t)return;function s(e,t){e&&(t?(e.classList.remove("no-display"),e.removeAttribute("disabled")):(e.classList.add("no-display"),e.disabled=!0))}const m={image:{content:!1,contentLabel:!1,imageUrl:!0,imageUrlLabel:!0,altText:!0,altTextLabel:!0,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},thumbnail:{content:!1,contentLabel:!1,imageUrl:!0,imageUrlLabel:!0,altText:!0,altTextLabel:!0,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},subheading:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},paragraph:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!1,colourLabel:!1,labelText:"Content"},button:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!0,urlTextLabel:!0,colourInput:!0,colourLabel:!0,labelText:"Button Text",urlLabelText:"Button Link"},default:{content:!0,contentLabel:!0,imageUrl:!1,imageUrlLabel:!1,altText:!1,altTextLabel:!1,urlText:!1,urlTextLabel:!1,colourInput:!0,colourLabel:!0,labelText:"Content"}},L=m[t.value]||m.default;L.contentLabel&&"string"==typeof L.labelText&&(l.textContent=L.labelText),L.urlTextLabel&&"string"==typeof L.labelText&&(u.textContent=L.urlLabelText),s(l,L.contentLabel),s(o,L.content),s(n,L.imageUrlLabel),s(r,L.imageUrl),s(a,L.altTextLabel),s(c,L.altText),s(u,L.urlTextLabel),s(i,L.urlText),s(b,L.colourLabel),s(d,L.colourInput)}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("add-block-btn"),t=document.getElementById("blocks-container"),l=document.getElementById("block-template"),o=document.getElementById("article-post");let n=0;function r(e,l,o){e.addEventListener("click",(function(e){e.preventDefault();const a=document.getElementById(l);a&&(a.remove(),function(e){const l=t.querySelectorAll(".article-block");for(let t=0;t<l.length;t++){const o=l[t],n=parseInt(o.id.split("-")[1]);if(n>e){const e=n-1;o.id=`block-${e}`,o.querySelectorAll("[name], [id], [for]").forEach((t=>{t.name&&(t.name=t.name.replace(`article-blocks-${n}-`,`article-blocks-${e}-`)),t.id&&(t.id=t.id.replace(`article-blocks-${n}-`,`article-blocks-${e}-`)),t.htmlFor&&(t.htmlFor=t.htmlFor.replace(`article-blocks-${n}-`,`article-blocks-${e}-`))}));const t=o.querySelector(`#rmv-block-btn-${n}`);t&&(t.id=`rmv-block-btn-${e}`,r(t,`block-${e}`,e))}}}(o),n--)}))}o.addEventListener("click",(function(e){confirm("Are you sure you want to upload this newsletter?")||e.preventDefault()})),t.querySelectorAll(".article-block").forEach((e=>{const t=e.querySelector(".block-type");t&&(t.addEventListener("change",(()=>updateBlockFields(e))),updateBlockFields(e))}));const a=document.querySelectorAll(".article-block");a.length&&a.length>0&&(n=a.length-1),e.addEventListener("click",(function(e){e.preventDefault();const o=l.cloneNode(!0);o.classList.remove("no-display"),o.removeAttribute("disabled");const a=o.innerHTML.replace(/__INDEX__/g,n);o.innerHTML=a,o.id=`block-${n}`;o.querySelector(".block-type").addEventListener("change",(function(){updateBlockFields(o)}));const c=o.querySelector(`#rmv-block-btn-${n}`);c&&r(c,`block-${n}`,n),t.appendChild(o),n++,updateBlockFields(o)})),document.getElementById("preview-button").addEventListener("click",(async function(){const e=document.getElementById("article-form"),t=new FormData(e),l=document.getElementById("preview-spinner"),o=document.getElementById("preview-error"),n=Date.now();l.style.display="flex",o.textContent="",await fetch(`/HDPSC-admin-panel/download-newsletter?ts=${n}`,{method:"POST",body:t}).then((async e=>{if(!e.ok){const t=await e.json();if(t.errors){let e="";for(const[l,o]of Object.entries(t.errors))e+=`${l}: ${o.join(", ")}\n`;throw new Error(e)}throw new Error(t.error||"Something went wrong")}return e.text()})).then((e=>{const t=new Blob([e],{type:"text/html"}),l=URL.createObjectURL(t),o=document.createElement("a");o.href=l,o.download=`newsletter-${n}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l)})).catch((e=>{o.textContent=e.message})).finally((()=>{l.style.display="none"}))}))}));