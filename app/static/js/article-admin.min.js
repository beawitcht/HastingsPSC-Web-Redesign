function updateBlockFields(e){const t=e.querySelector(".block-type"),n=e.querySelector(".content-label"),o=e.querySelector(".block-content"),l=e.querySelector(".image-url-label"),c=e.querySelector(".block-image-url"),r=e.querySelector(".alt-text-label"),i=e.querySelector(".block-alt-text"),a=e.querySelector(".url-text-label"),d=e.querySelector(".block-url-text");if(!t)return;const s=t.value;function u(e,t){e&&(t?(e.classList.remove("no-display"),e.removeAttribute("disabled")):(e.classList.add("no-display"),e.disabled=!0))}n.textContent="figure"===s?"Caption":"Content","image"===s?(u(n,!1),u(o,!1),u(l,!0),u(c,!0),u(r,!0),u(i,!0),u(a,!1),u(d,!1)):"figure"===s?(n.textContent="Caption",u(n,!0),u(o,!0),u(l,!0),u(c,!0),u(r,!0),u(i,!0),u(a,!1),u(d,!1)):"link"===s?(n.textContent="URL",u(n,!0),u(o,!0),u(l,!1),u(c,!1),u(r,!1),u(i,!1),u(a,!0),u(d,!0)):"paragraph"===s?(u(n,!0),u(o,!0),u(l,!1),u(c,!1),u(r,!1),u(i,!1),u(a,!1),u(d,!1)):"break"===s?(u(n,!1),u(o,!1),u(l,!1),u(c,!1),u(r,!1),u(i,!1),u(a,!1),u(d,!1)):(n.textContent="Content",u(n,!0),u(o,!0),u(l,!1),u(c,!1),u(r,!1),u(i,!1),u(a,!1),u(d,!1))}document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("add-block-btn"),t=document.getElementById("blocks-container"),n=document.getElementById("block-template"),o=document.getElementById("article-post");let l=0;function c(e,n){e.addEventListener("click",(function(e){e.preventDefault();const o=document.getElementById(n);o&&(o.remove(),a(),l=t.querySelectorAll(".article-block").length)}))}function r(e,t){e.addEventListener("click",(function(e){e.preventDefault();const n=document.getElementById(`block-${t}`),o=n.previousElementSibling;o&&o.classList.contains("article-block")&&(n.parentNode.insertBefore(n,o),a())}))}function i(e,t){e.addEventListener("click",(function(e){e.preventDefault();const n=document.getElementById(`block-${t}`),o=n.nextElementSibling;o&&o.classList.contains("article-block")&&(n.parentNode.insertBefore(o,n),a())}))}function a(){t.querySelectorAll(".article-block").forEach(((e,t)=>{e.id=`block-${t}`,e.querySelectorAll("[name], [id], [for]").forEach((e=>{e.name&&(e.name=e.name.replace(/article-blocks-\d+-/,`article-blocks-${t}-`)),e.id&&(e.id=e.id.replace(/article-blocks-\d+-/,`article-blocks-${t}-`)),e.htmlFor&&(e.htmlFor=e.htmlFor.replace(/article-blocks-\d+-/,`article-blocks-${t}-`))}));const n=e.querySelector('[id^="rmv-block-btn-"]');if(n){n.id=`rmv-block-btn-${t}`,n.replaceWith(n.cloneNode(!0));c(e.querySelector(`#rmv-block-btn-${t}`),`block-${t}`)}const o=e.querySelector('[id^="up-block-btn-"]');if(o){o.id=`up-block-btn-${t}`,o.replaceWith(o.cloneNode(!0));r(e.querySelector(`#up-block-btn-${t}`),t)}const l=e.querySelector('[id^="down-block-btn-"]');if(l){l.id=`down-block-btn-${t}`,l.replaceWith(l.cloneNode(!0));i(e.querySelector(`#down-block-btn-${t}`),t)}const a=e.querySelector(".block-type");a&&(a.addEventListener("change",(()=>updateBlockFields(e))),updateBlockFields(e))}))}o.addEventListener("click",(function(e){confirm("Are you sure you want to upload this article?")||e.preventDefault()})),t.querySelectorAll(".article-block").forEach((e=>{const t=e.querySelector(".block-type");t&&(t.addEventListener("change",(()=>updateBlockFields(e))),updateBlockFields(e))}));const d=document.querySelectorAll(".article-block");d.length>0&&(l=d.length,a()),e.addEventListener("click",(function(e){e.preventDefault();const o=n.cloneNode(!0);o.classList.remove("no-display"),o.removeAttribute("disabled");const a=o.innerHTML.replace(/__INDEX__/g,l);o.innerHTML=a,o.id=`block-${l}`;o.querySelector(".block-type").addEventListener("change",(function(){updateBlockFields(o)}));const d=o.querySelector(`#rmv-block-btn-${l}`);d&&c(d,`block-${l}`);const s=o.querySelector(`#up-block-btn-${l}`);s&&r(s,l);const u=o.querySelector(`#down-block-btn-${l}`);u&&i(u,l),t.appendChild(o),l++,updateBlockFields(o)})),document.getElementById("preview-button").addEventListener("click",(async function(){const e=document.getElementById("article-form"),t=new FormData(e),n=document.getElementById("preview-shadow-host"),o=document.getElementById("preview-spinner"),l=document.getElementById("preview-error"),c=Date.now();o.style.display="flex",l.textContent="",await fetch(`/HDPSC-admin-panel/preview-article?ts=${c}`,{method:"POST",body:t}).then((async e=>{if(!e.ok){const t=await e.json();if(t.errors){let e="";for(const[n,o]of Object.entries(t.errors))e+=`${n}: ${o.join(", ")}\n`;throw new Error(e)}throw new Error(t.error||"Something went wrong")}return e.text()})).then((e=>{const t=function(e,t="preview-"){return e.replace(/id="([^"]+)"/g,((e,n)=>`id="${t}${n}"`)).replace(/for="([^"]+)"/g,((e,n)=>`for="${t}${n}"`)).replace(/name="([^"]+)"/g,((e,n)=>`name="${t}${n}"`)).replace(/class="([^"]+)"/g,((e,n)=>`class="${n.split(" ").map((e=>`${t}${e}`)).join(" ")}"`))}(e,"preview-");n.shadowRoot||n.attachShadow({mode:"open"});const o=n.shadowRoot;o.innerHTML="";const l=document.createElement("link");l.rel="stylesheet",l.href="/static/css/preview-base.css",o.appendChild(l);const c=document.createElement("link");c.rel="stylesheet",c.href="/static/css/preview-article.css",o.appendChild(c);const r=document.createElement("div");r.innerHTML=t,o.appendChild(r)})).catch((e=>{l.textContent=e.message})).finally((()=>{n.classList.remove("hidden-rendered"),o.style.display="none"}))}))}));